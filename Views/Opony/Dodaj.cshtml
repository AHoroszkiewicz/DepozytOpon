@model DepozytOpon.Models.Opona

<h2>Dodaj oponę</h2>
<button class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#scrapeModal">
    Pobierz z linku
</button>
<div id="scrapeAlert" class="alert d-none" role="alert"></div>
<form asp-action="Dodaj" method="post">
    <div class="form-group">
        <label>Typ</label>
        <input class="form-control" asp-for="Typ" />
    </div>

    <div class="form-group">
        <label>Producent</label>
        <input class="form-control" asp-for="Producent" />
    </div>

    <div class="form-group">
        <label>Rozmiar</label>
        <input class="form-control" asp-for="Rozmiar" />
    </div>

    <div class="form-group">
        <label>Bieżnik</label>
        <input class="form-control" asp-for="Bieznik" />
    </div>

    <div class="form-group">
        <label>Sezon</label>
        <input class="form-control" asp-for="Sezon" />
    </div>

    <div class="form-group">
        <label>Rok produkcji</label>
        <input class="form-control" asp-for="RokProdukcji" />
    </div>

    <div class="form-group">
        <label>Kod towaru</label>
        <input class="form-control" asp-for="KodTowaru" />
    </div>

    <button type="submit" class="btn btn-primary mt-3">Zapisz</button>
    <a asp-action="Index" asp-controller="Opony" class="btn btn-secondary mt-3">Wstecz</a>
</form>
<div class="modal fade" id="scrapeModal" tabindex="-1" aria-hidden="true">
    <div id="scrapeAlert" class="alert d-none" role="alert"></div>
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Pobierz dane opony z linku</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input id="scrapeUrl" class="form-control mb-3" placeholder="Wklej link do opony">

                <div id="scrapeLoader" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">Pobieranie danych…</div>
                </div>
            </div>


            <div class="modal-footer">
                <button id="scrapeBtn" class="btn btn-primary" onclick="scrape()">Generuj</button>
            </div>

        </div>
    </div>
</div>
<script>
    function showAlert(type, message) {
        const alert = document.getElementById("scrapeAlert");
        alert.className = `alert alert-${type}`;
        alert.innerText = message;
        alert.classList.remove("d-none");
    }

    function scrape() {
        const url = document.getElementById("scrapeUrl").value;
        const loader = document.getElementById("scrapeLoader");
        const btn = document.getElementById("scrapeBtn");

        // UI start
        loader.classList.remove("d-none");
        btn.disabled = true;

        fetch("/Scraper/Scrape", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "url=" + encodeURIComponent(url)
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) {
                showAlert("danger", "❌ Błąd scrapowania: " + d.error);
                return;
            }

            const o = d.data;

            // Uzupełniamy TYLKO znalezione pola
            if (o.typ) document.getElementById("Typ").value = o.typ;
            if (o.producent) document.getElementById("Producent").value = o.producent;
            if (o.rozmiar) document.getElementById("Rozmiar").value = o.rozmiar;
            if (o.bieznik) document.getElementById("Bieznik").value = o.bieznik;
            if (o.sezon) document.getElementById("Sezon").value = o.sezon;
            if (o.rokProdukcji) document.getElementById("RokProdukcji").value = o.rokProdukcji;
            if (o.kodTowaru) document.getElementById("KodTowaru").value = o.kodTowaru;

            showAlert("success", "✅ Dane zostały pobrane poprawnie");

            // Zamykamy modal
            const modal = bootstrap.Modal.getInstance(
                document.getElementById("scrapeModal")
            );
            modal.hide();
        })
        .catch(() => {
            showAlert("danger", "❌ Wystąpił błąd połączenia z serwerem");
        })
        .finally(() => {
            loader.classList.add("d-none");
            btn.disabled = false;
        });
    }
</script>


